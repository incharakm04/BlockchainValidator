<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Blockchain Simulator</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        .block {
            border: 2px solid #198754;
            padding: 15px;
            margin: 15px;
            border-radius: 10px;
            background-color: #f8f9fa;
            box-shadow: 2px 2px 8px rgba(0,0,0,0.1);
        }
        .tampered {
            border-color: #dc3545 !important;
            background-color: #ffe6e6 !important;
        }
        .block-title {
            font-weight: bold;
        }
    </style>
</head>
<body class="bg-light">
<div class="container my-4">
    <h1 class="text-center mb-4">🧱 Blockchain Simulator</h1>

    <!-- Add Block Form -->
    <div class="mb-4">
        <form id="addForm" class="d-flex gap-2">
            <input type="text" name="data" placeholder="Enter block data" required class="form-control">
            <button type="submit" class="btn btn-success">Add Block</button>
        </form>
    </div>

    <!-- Tamper Block Form -->
    <div class="mb-4">
        <form id="tamperForm" class="row g-2">
            <div class="col-md-4">
                <input type="number" name="index" placeholder="Block Index" required class="form-control">
            </div>
            <div class="col-md-6">
                <input type="text" name="new_data" placeholder="New Tampered Data" required class="form-control">
            </div>
            <div class="col-md-2">
                <button type="submit" class="btn btn-danger w-100">Tamper Block</button>
            </div>
        </form>
    </div>

    <!-- Validate Button -->
    <div class="text-center mb-4">
        <button id="validateBtn" class="btn btn-warning">Validate Blockchain</button>
    </div>

    <!-- Blockchain Display -->
    <div id="chainDisplay" class="row"></div>
</div>

<!-- Bootstrap & Axios -->
<script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
<script>
    function loadChain() {
        axios.get('/get_chain').then(response => {
            const chain = response.data;
            const container = document.getElementById('chainDisplay');
            container.innerHTML = '';

            chain.forEach(block => {
                const blockDiv = document.createElement('div');
                blockDiv.className = 'col-md-4 block';
                blockDiv.innerHTML = `
                    <div class="block-title">Block #${block.index}</div>
                    <div><strong>Data:</strong> ${block.data}</div>
                    <div><strong>Hash:</strong> ${block.hash.substring(0, 20)}...</div>
                    <div><strong>Previous:</strong> ${block.previous_hash.substring(0, 20)}...</div>
                    <div><strong>Time:</strong> ${block.timestamp}</div>
                `;
                container.appendChild(blockDiv);
            });
        });
    }

    // Add block form handler
    document.getElementById('addForm').addEventListener('submit', function (e) {
        e.preventDefault();
        const formData = new FormData(this);
        axios.post('/add_block', formData).then(() => {
            loadChain();
            this.reset();
        });
    });

    // Tamper block form handler
    document.getElementById('tamperForm').addEventListener('submit', function (e) {
        e.preventDefault();
        const formData = new FormData(this);
        axios.post('/tamper_block', formData).then(() => {
            loadChain();
            this.reset();
        });
    });

    // Validate blockchain
    document.getElementById('validateBtn').addEventListener('click', function () {
        axios.get('/validate_chain').then(response => {
            const isValid = response.data.is_valid;
            if (!isValid) {
                alert("⚠️ Blockchain is Tampered!");
                highlightTamperedBlocks();
            } else {
                alert("✅ Blockchain is Valid!");
            }
        });
    });

    // Highlight tampered blocks
    function highlightTamperedBlocks() {
        axios.get('/get_chain').then(response => {
            const chain = response.data;
            const container = document.getElementById('chainDisplay');
            container.innerHTML = '';

            chain.forEach((block, index) => {
                const tempBlock = JSON.stringify({
                    index: block.index,
                    timestamp: block.timestamp,
                    data: block.data,
                    previous_hash: block.previous_hash
                });
                const computedHash = sha256(tempBlock);

                const isTampered = (computedHash !== block.hash);

                const blockDiv = document.createElement('div');
                blockDiv.className = `col-md-4 block ${isTampered ? 'tampered' : ''}`;
                blockDiv.innerHTML = `
                    <div class="block-title">Block #${block.index}</div>
                    <div><strong>Data:</strong> ${block.data}</div>
                    <div><strong>Hash:</strong> ${block.hash.substring(0, 20)}...</div>
                    <div><strong>Previous:</strong> ${block.previous_hash.substring(0, 20)}...</div>
                    <div><strong>Time:</strong> ${block.timestamp}</div>
                `;
                container.appendChild(blockDiv);
            });
        });
    }

    // SHA256 in JS (using SubtleCrypto)
    async function sha256(message) {
        const msgBuffer = new TextEncoder().encode(message);
        const hashBuffer = await crypto.subtle.digest('SHA-256', msgBuffer);
        const hashArray = Array.from(new Uint8Array(hashBuffer));
        return hashArray.map(b => b.toString(16).padStart(2, '0')).join('');
    }

    // Initial load
    loadChain();
</script>
</body>
</html>
